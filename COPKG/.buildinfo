@import "version.inc";

#define {
    NewVersion : "${package-version++}";
}

#product-info  {
    product-name: "pixman";
    version: "${package-version}";
    original-source-location: "git://anongit.freedesktop.org/git/pixman";
    original-source-website: "http://pixman.org/";
    license: "Expat/MIT License";
    packager: "Vincent Povirk <madewokherd@gmail.com>";
}

/* 
    Maintainer notes:
    
    After merging a new version:
	 * Edit COPKG\pixman\pixman-version.h with the changed version number.
	 * Update COPKG\pixman\pixman\pixman.def with any new exports.
*/


x86{
	requires: {
		"perl-monolithic[vc10]",
	};

    compiler: vc10;
    platform: x86;
     
    targets: { 
        "COPKG\pixman\Release\pixman.dll",
        "COPKG\pixman\Release\pixman.lib"
    };
     
    build-command:@"
		if ""${BUILT}"" equ ""true"" goto end
        cd COPKG\pixman
	    msbuild /p:Platform=Win32 /p:Configuration=Release pixman.sln
:end
    ";
     
    clean-command:@"
        cd COPKG\pixman
	    msbuild /p:Platform=Win32 /p:Configuration=Release /target:Clean pixman.sln
    ";
};

release {
	uses: x86;
}

test {
	uses: release;
}

package {
	uses: release;

	build-command:@"
        if ""${noversion}"" neq ""true"" ptk update-version
		cd COPKG
		autopackage pixman-dev-common.autopkg || goto failed
		autopackage pixman.autopkg pixman-dev.autopkg || goto failed
	";

	targets: {
		"COPKG\pixman[vc10]-${NewVersion}-x86.msi",
		"COPKG\pixman-dev[vc10]-${NewVersion}-x86.msi",
		"COPKG\pixman-dev-common-${NewVersion}-any.msi",
	};

	clean-command:@"
		del COPKG\*.msi
		del COPKG\*.wixpdb
	";
}

update-version {
    default : false;
    
    build-command : @"
        REM auto-increment version.inc file...
        
        pushd COPKG
        setlocal EnableDelayedExpansion
        set VERSTRING=#define { package-version: ${NewVersion}; }
        echo !VERSTRING! > version.inc
        popd
    ";
}
